---
layout: post
title: 'kubernetes unused image clean up'
date: 2021-3-22
author: zhuoli
cover: 'http://on2171g4d.bkt.clouddn.com/jekyll-banner.png'
tags: tech 
---

在开发Kubernetes应用时，我们有时需要操作node level resources, 这时候就不能做个简单的 pod deployment (类似沙盒 不会碰node resources)。 现在就可以用 [node-shell](https://github.com/kvaps/kubectl-node-shell)这一插件。

# Start a root shell in the node's host OS running.

echo "Cleaning up old images..."
echo "Installing kubectl node shell..."
# https://github.com/kvaps/kubectl-node-shell
curl -LO https://github.com/kvaps/kubectl-node-shell/raw/master/kubectl-node_shell
chmod +x ./kubectl-node_shell
sudo mv ./kubectl-node_shell /usr/local/bin/kubectl-node_shell
echo "Done"

names=$(kubectl get node -o json | jq '.items[].metadata.name' -r)
nodecount=$(echo "$names" | wc -l)
echo "AKS underlay has $nodecount vm instances, going to prune docker images one by one"

# loop 
while IFS= read -r nodename; do
    echo "**************** prude node: $nodename ****************"
    kubectl node-shell $nodename -- sh -c 'yes | docker image prune'
    echo "**************** Done ****************"
done <<< "$names"
echo "********************** END **************************"
echo "Prune finished"